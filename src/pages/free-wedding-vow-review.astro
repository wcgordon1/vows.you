---
import BaseLayout from "@/layouts/BaseLayout.astro"
import Wrapper from "@/components/fundations/containers/Wrapper.astro"
import Text from "@/components/fundations/elements/Text.astro"
import BlogCard from "@/components/blog/BlogCard.astro"
import VowsNextStepCard from "@/components/VowsNextStepCard.astro"
import SendToAIReview from "@/components/SendToAIReview.astro"
import JsonLd from "@/components/fundations/head/JsonLd.astro"
import { getCollection } from "astro:content"

// Get recent posts for the bottom section
const posts = (await getCollection("posts"))
	.sort((a, b) => new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf())
	.slice(0, 4)

const SITE_URL = "https://vows.you";

// HowTo structured data for the vow review tool
const howToSchema = {
	"@context": "https://schema.org",
	"@type": "HowTo",
	"name": "How to Review Your Wedding Vows for Length and Clichés",
	"description": "Check your wedding vows for ideal length, read time, and cringy clichés. Get suggestions to make your vows more personal.",
	"image": `${SITE_URL}/og-image.jpg`,
	"totalTime": "PT2M",
	"estimatedCost": {
		"@type": "MonetaryAmount",
		"currency": "USD",
		"value": "0"
	},
	"tool": {
		"@type": "HowToTool",
		"name": "vows.you Wedding Vow Review Tool"
	},
	"step": [
		{
			"@type": "HowToStep",
			"position": 1,
			"name": "Paste your vows",
			"text": "Copy and paste your wedding vows into the text area to begin the analysis."
		},
		{
			"@type": "HowToStep",
			"position": 2,
			"name": "Choose analysis mode",
			"text": "Select whether you're analyzing wedding vows (stricter) or an officiant speech (looser standards)."
		},
		{
			"@type": "HowToStep",
			"position": 3,
			"name": "Review highlighted issues",
			"text": "See highlighted weak phrases and clichés with severity indicators. Click any highlight for suggestions."
		},
		{
			"@type": "HowToStep",
			"position": 4,
			"name": "Get personalization suggestions",
			"text": "Click on highlighted phrases to get specific rewrite suggestions and prompts to make them more personal."
		}
	]
};

// WebApplication structured data
const webAppSchema = {
	"@context": "https://schema.org",
	"@type": "WebApplication",
	"name": "Wedding Vow Review & Cliché Checker",
	"url": `${SITE_URL}/free-wedding-vow-review`,
	"applicationCategory": "LifestyleApplication",
	"operatingSystem": "Web",
	"offers": {
		"@type": "Offer",
		"price": "0",
		"priceCurrency": "USD"
	},
	"description": "Free wedding vow analyzer. Check length, read time, and detect clichéd phrases. Get suggestions to make your vows more personal.",
	"featureList": [
		"Word count and read time analysis",
		"Cliché and weak phrase detection",
		"Severity-based highlighting",
		"Rewrite suggestions",
		"Privacy-first (browser-only)"
	]
};

const breadcrumbSchema = {
	"@context": "https://schema.org",
	"@type": "BreadcrumbList",
	"itemListElement": [
		{
			"@type": "ListItem",
			"position": 1,
			"name": "Home",
			"item": SITE_URL
		},
		{
			"@type": "ListItem",
			"position": 2,
			"name": "Free Wedding Vow Review",
			"item": `${SITE_URL}/free-wedding-vow-review`
		}
	]
};
---

<BaseLayout
	title="Free Wedding Vow Review - Length, Timing & Cliché Checker | vows.you"
	description="Check your wedding vows for ideal length, read time, and cringy clichés. Highlights weak phrases with rewrite suggestions. Privacy-first and fully in-browser."
>
	<JsonLd slot="head" data={howToSchema} />
	<JsonLd slot="head" data={webAppSchema} />
	<JsonLd slot="head" data={breadcrumbSchema} />

	<section>
		<Wrapper variant="standard" class="pt-32 pb-8">
			<!-- Header -->
			<header class="max-w-3xl mb-12">
				<p class="text-sm font-medium uppercase tracking-wide text-accent-500 mb-4">
					Wedding Vow Analyzer
				</p>
				<Text tag="h1" variant="displayMD" class="font-serif font-medium tracking-tight text-base-900 mb-6">
					Free Wedding Vow Review
				</Text>
				<Text tag="p" variant="textLG" class="text-base-600 leading-relaxed">
					Paste your wedding vows to check length and read time, and detect clichéd or vague wording like "you are my rock" or "forever and always". Click highlights for better options and prompts to make it sound like you.
				</Text>
				<p class="text-sm text-base-500 mt-4 flex items-center gap-2">
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600">
						<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
					</svg>
					We value your privacy. This text never leaves your computer.
				</p>
			</header>

			<!-- Main Tool Area -->
			<div class="grid gap-10 lg:grid-cols-[1.2fr_0.8fr]">
				<!-- Left Column: Input + Preview -->
				<div class="space-y-6 min-w-0">
					<!-- Input Header -->
					<div class="rounded-2xl border border-base-200 bg-base-50/50 p-4 flex items-center justify-between flex-wrap gap-4">
						<h2 class="text-lg font-medium text-base-800" id="text-input-label">
							Analyze your vows for clichés
						</h2>
						<div class="flex items-center gap-4">
							<select
								id="mode-select"
								class="text-sm px-3 py-1.5 rounded-lg bg-base-100 border border-base-200 cursor-pointer focus:outline-none focus:ring-2 focus:ring-accent-500/30"
								aria-label="Analysis mode"
							>
								<option value="vows" selected>Wedding vows (stricter)</option>
								<option value="speech">Officiant / speech (looser)</option>
							</select>
							<button
								id="reset-btn"
								type="button"
								class="hidden text-sm px-3 py-1.5 rounded-lg bg-base-100 border border-base-200 hover:bg-base-200 transition-colors cursor-pointer"
							>
								Reset
							</button>
						</div>
					</div>

					<!-- Textarea -->
					<textarea
						id="text-input"
						aria-labelledby="text-input-label"
						class="w-full max-w-full h-[260px] md:h-[320px] rounded-2xl border border-base-200 bg-white p-5 text-base leading-relaxed shadow-sm focus:outline-none focus:ring-2 focus:ring-accent-500/30 resize-none overflow-y-auto overflow-x-hidden break-words"
						placeholder="Paste your wedding vows here…"
						spellcheck="true"
					></textarea>

					<!-- Highlighted Preview -->
					<div class="space-y-4">
						<div class="flex items-center justify-between">
							<h2 class="text-lg font-medium text-base-800">
								Highlighted Preview
							</h2>
							<span class="text-sm text-base-500">
								Click a highlight for suggestions
							</span>
						</div>
						
						<!-- Legend -->
						<div class="flex flex-wrap gap-4 text-sm font-medium">
							<span class="flex items-center gap-1.5">
								<span class="w-3 h-3 rounded weak--high-preview"></span>
								High severity
							</span>
							<span class="flex items-center gap-1.5">
								<span class="w-3 h-3 rounded weak--med-preview"></span>
								Medium severity
							</span>
							<span class="flex items-center gap-1.5">
								<span class="w-3 h-3 rounded weak--low-preview"></span>
								Low severity
							</span>
						</div>

						<div
							id="highlight-preview"
							class="min-h-[180px] max-h-[400px] whitespace-pre-wrap rounded-2xl border border-base-200 bg-base-50/50 p-5 text-base leading-relaxed overflow-y-auto overflow-x-hidden break-words"
						>
							Your highlighted preview will appear here.
						</div>
					</div>
				</div>

				<!-- Right Column: Stats + Panels -->
				<div class="space-y-6 min-w-0">
					<!-- Next Step Card -->
					<VowsNextStepCard toolName="free-wedding-vow-review" />

					<!-- Summary Statistics -->
					<div class="space-y-3">
						<h3 class="text-lg font-medium text-base-800">
							Analysis Summary
						</h3>
						<div class="rounded-2xl border border-base-200 bg-base-50/50 p-4">
							<div class="grid grid-cols-2 gap-4">
								<div>
									<p class="text-2xl font-bold text-base-700" data-stat="total-words">0</p>
									<p class="text-sm text-base-500 mt-0.5">Words</p>
								</div>
								<div>
									<p class="text-2xl font-bold text-base-700" data-stat="read-time">0:00</p>
									<p class="text-sm text-base-500 mt-0.5">Read Time</p>
								</div>
								<div>
									<p class="text-2xl font-bold text-base-700" data-stat="weak-hits">0</p>
									<p class="text-sm text-base-500 mt-0.5">Weak Phrases</p>
								</div>
								<div>
									<p class="text-2xl font-bold text-base-700" data-stat="unique-phrases">0</p>
									<p class="text-sm text-base-500 mt-0.5">Unique Issues</p>
								</div>
							</div>
						</div>
					</div>

					<!-- Severity Rating -->
					<div class="space-y-3">
						<h3 class="text-sm font-medium text-base-500">
							Overall Rating
						</h3>
						<div id="severity-card" class="rounded-2xl border border-base-200 bg-base-50/50 p-4">
							<div class="flex items-center justify-between">
								<div>
									<p class="text-3xl font-bold" data-stat="severity-label">--</p>
									<p class="text-sm text-base-500 mt-0.5" data-stat="severity-description">Paste vows to analyze</p>
								</div>
							</div>
						</div>
					</div>

					<!-- Length Guidance -->
					<div class="space-y-3">
						<h3 class="text-sm font-medium text-base-500">
							Length Guidance
						</h3>
						<div class="rounded-2xl border border-base-200 bg-base-50/50 p-4">
							<p class="text-sm text-base-600" data-stat="length-guidance">
								Paste your vows to get length feedback.
							</p>
						</div>
					</div>

					<!-- Category Breakdown -->
					<div class="space-y-3">
						<h3 class="text-sm font-medium text-base-500">
							Issues by Category
						</h3>
						<div id="category-breakdown" class="rounded-2xl border border-base-200 bg-base-50/50 p-4 space-y-2">
							<p class="text-sm text-base-500">No issues detected yet.</p>
						</div>
					</div>

					<!-- Top 5 Issues -->
					<div class="space-y-3">
						<h3 class="text-sm font-medium text-base-500">
							Top Issues to Fix
						</h3>
						<div id="top-phrases" class="rounded-2xl border border-base-200 bg-base-50/50 p-4 space-y-3">
							<p class="text-sm text-base-500">No issues detected yet.</p>
						</div>
					</div>

					<!-- Insights Section -->
					<div id="insights-section" class="space-y-3">
						<h3 class="text-sm font-medium text-base-500">
							Insights
						</h3>
						<div class="rounded-2xl border border-base-200 bg-base-50/50 p-4 space-y-4">
							<p class="text-lg font-semibold text-base-700" data-stat="insights-headline">
								Paste vows to analyze
							</p>
							<div id="insights-bullets" class="space-y-1 text-sm text-base-600">
							</div>
							<div id="insights-actions" class="space-y-1 text-sm text-base-700">
							</div>
						</div>
					</div>

					<!-- Send to AI Review -->
					<SendToAIReview toolId="free-wedding-vow-review" />
				</div>
			</div>
		</Wrapper>
	</section>

	<!-- Tooltip for hover -->
	<div
		id="tooltip"
		class="fixed z-50 hidden max-w-xs p-3 rounded-xl shadow-lg border border-base-200 bg-white text-sm"
		role="tooltip"
	>
		<p class="font-semibold text-base-800 mb-1" id="tooltip-title"></p>
		<p class="text-base-600 mb-2" id="tooltip-why"></p>
		<p class="text-xs text-base-500">Click for suggestions</p>
	</div>

	<!-- Fix This Phrase Modal -->
	<div
		id="fix-modal-backdrop"
		class="fix-modal-backdrop"
		aria-hidden="true"
	></div>
	<aside
		id="fix-panel"
		class="fix-modal-panel"
		role="dialog"
		aria-modal="true"
		aria-labelledby="fix-panel-title"
	>
		<!-- Header -->
		<header class="fix-modal-header">
			<div class="flex items-center gap-3">
				<div class="flex items-center justify-center w-10 h-10 rounded-xl bg-gradient-to-br from-amber-100 to-amber-50 text-amber-600">
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<path d="M12 20h9"></path>
						<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
					</svg>
				</div>
				<div>
					<h2 id="fix-panel-title" class="text-lg font-semibold text-base-900">Fix This Phrase</h2>
					<p class="text-sm text-base-500">Make it personal</p>
				</div>
			</div>
			<button
				id="close-fix-panel"
				type="button"
				class="fix-modal-close"
				aria-label="Close panel"
			>
				<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
					<path d="M18 6 6 18"></path>
					<path d="m6 6 12 12"></path>
				</svg>
			</button>
		</header>

		<!-- Content -->
		<div class="fix-modal-content">
			<!-- The phrase being fixed -->
			<div class="fix-modal-phrase-card">
				<p class="text-xs font-medium uppercase tracking-wider text-amber-700 mb-2">Cliché Detected</p>
				<p class="text-xl font-semibold text-base-900 leading-snug" id="fix-phrase-text"></p>
			</div>

			<!-- Why it's a problem -->
			<div class="fix-modal-section">
				<div class="flex items-center gap-2 mb-2">
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-base-400">
						<circle cx="12" cy="12" r="10"></circle>
						<path d="M12 16v-4"></path>
						<path d="M12 8h.01"></path>
					</svg>
					<h3 class="text-sm font-semibold text-base-700">Why personalize this?</h3>
				</div>
				<p class="text-sm text-base-600 leading-relaxed" id="fix-why"></p>
			</div>

			<!-- Suggestions -->
			<div class="fix-modal-section">
				<div class="flex items-center gap-2 mb-3">
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-base-400">
						<path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
					</svg>
					<h3 class="text-sm font-semibold text-base-700">Try these instead</h3>
				</div>
				<div id="fix-suggestions" class="flex flex-wrap gap-2"></div>
			</div>

			<!-- Prompts -->
			<div class="fix-modal-section">
				<div class="flex items-center gap-2 mb-3">
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-base-400">
						<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
					</svg>
					<h3 class="text-sm font-semibold text-base-700">Ask yourself</h3>
				</div>
				<ul id="fix-prompts" class="space-y-2"></ul>
			</div>
		</div>

		<!-- Footer -->
		<footer class="fix-modal-footer">
			<button
				id="fix-panel-done"
				type="button"
				class="fix-modal-done-btn"
			>
				Got it, thanks!
			</button>
		</footer>
	</aside>

	<!-- Related Tools Section -->
	<section class="mt-24 border-t border-base-200 border-dashed">
		<Wrapper variant="standard" class="py-12">
			<div class="max-w-xl mx-auto text-center">
				<Text tag="h2" variant="displaySM" class="font-serif font-medium text-base-900">
					Need help writing your vows?
				</Text>
				<Text tag="p" variant="textBase" class="mt-4 text-base-500">
					Our free wedding vows template guides you through prompts to generate ceremony-ready vows in minutes.
				</Text>
				<a
					href="/wedding-vows-template"
					class="inline-flex items-center gap-2 mt-6 px-6 py-3 text-sm font-semibold text-white bg-accent-500 rounded-full hover:bg-accent-600 transition-colors"
				>
					Try Free Vows Template
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<path d="M5 12h14"/>
						<path d="m12 5 7 7-7 7"/>
					</svg>
				</a>
			</div>
		</Wrapper>
	</section>

	<!-- Recent Posts Section -->
	<section class="pb-24">
		<Wrapper variant="standard">
			<Text tag="h2" variant="displaySM" class="font-serif font-medium text-base-900">
				Enjoying the Vow Review?
			</Text>
			<Text tag="p" variant="textBase" class="text-base-600 mb-12 mt-2">
				Check out our latest guides on writing wedding vows that sound like you.
			</Text>
			<div class="grid grid-cols-1 gap-8 md:grid-cols-2 lg:grid-cols-4 gap-y-12">
				{posts.map((post) => <BlogCard post={post} />)}
			</div>
			<a 
				href="/guides" 
				class="inline-flex items-center gap-2 mt-8 text-accent-600 hover:text-accent-700 font-medium transition-colors"
			>
				Read All Guides
				<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
					<path d="M5 12h14"/>
					<path d="m12 5 7 7-7 7"/>
				</svg>
			</a>
		</Wrapper>
	</section>

	<!-- Global styles for dynamic highlight elements -->
	<style is:global>
		/* Weak phrase highlight styles */
		.weak-phrase {
			cursor: pointer;
			border-radius: 2px;
			transition: all 0.15s ease;
		}

		.weak-phrase:hover {
			filter: brightness(0.9);
		}

		.weak-phrase:focus {
			outline: 2px solid var(--color-accent-500);
			outline-offset: 1px;
		}

		/* High severity - red */
		.weak--high {
			background-color: #FEE2E2;
			text-decoration: underline;
			text-decoration-color: #EF4444;
			text-decoration-thickness: 2px;
			text-underline-offset: 2px;
		}

		/* Medium severity - amber */
		.weak--med {
			background-color: #FEF3C7;
			text-decoration: underline;
			text-decoration-color: #F59E0B;
			text-decoration-thickness: 2px;
			text-underline-offset: 2px;
		}

		/* Low severity - blue */
		.weak--low {
			background-color: #DBEAFE;
			text-decoration: underline;
			text-decoration-color: #3B82F6;
			text-decoration-thickness: 1px;
			text-underline-offset: 2px;
		}

		/* Legend preview swatches */
		.weak--high-preview {
			background-color: #FEE2E2;
			border: 1px solid #EF4444;
		}

		.weak--med-preview {
			background-color: #FEF3C7;
			border: 1px solid #F59E0B;
		}

		.weak--low-preview {
			background-color: #DBEAFE;
			border: 1px solid #3B82F6;
		}

		/* Severity color classes */
		.severity-great {
			color: #16A34A;
		}

		.severity-fair {
			color: #D97706;
		}

		.severity-weak {
			color: #DC2626;
		}

		/* Category badge */
		.category-badge {
			display: inline-flex;
			align-items: center;
			justify-content: space-between;
			padding: 0.25rem 0.5rem;
			border-radius: 0.375rem;
			font-size: 0.875rem;
			background-color: rgb(0 0 0 / 0.05);
		}

		/* Suggestion chip */
		.suggestion-chip {
			display: inline-block;
			padding: 0.5rem 1rem;
			border-radius: 9999px;
			font-size: 0.875rem;
			font-weight: 500;
			background-color: #F0FDF4;
			color: #15803D;
			border: 1px solid #BBF7D0;
			transition: all 0.15s ease;
		}

		.suggestion-chip:hover {
			background-color: #DCFCE7;
		}

		/* Fix Modal Backdrop */
		.fix-modal-backdrop {
			position: fixed;
			inset: 0;
			background-color: rgb(0 0 0 / 0);
			backdrop-filter: blur(0);
			z-index: 100;
			pointer-events: none;
			transition: all 0.3s ease;
		}

		.fix-modal-backdrop.is-visible {
			background-color: rgb(0 0 0 / 0.25);
			backdrop-filter: blur(4px);
			pointer-events: auto;
		}

		/* Fix Modal Panel */
		.fix-modal-panel {
			position: fixed;
			z-index: 101;
			background: white;
			display: flex;
			flex-direction: column;
			overflow: hidden;
			transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);

			/* Desktop: slide from right */
			top: 0;
			right: 0;
			bottom: 0;
			width: 420px;
			max-width: 100vw;
			transform: translateX(100%);
			border-left: 1px solid rgb(0 0 0 / 0.08);
			box-shadow: -8px 0 32px rgb(0 0 0 / 0.12);
		}

		.fix-modal-panel.is-visible {
			transform: translateX(0);
		}

		/* Mobile: slide from bottom */
		@media (max-width: 640px) {
			.fix-modal-panel {
				top: auto;
				left: 0;
				right: 0;
				bottom: 0;
				width: 100%;
				max-height: 90vh;
				transform: translateY(100%);
				border-left: none;
				border-top: 1px solid rgb(0 0 0 / 0.08);
				border-radius: 1.5rem 1.5rem 0 0;
				box-shadow: 0 -8px 32px rgb(0 0 0 / 0.15);
			}

			.fix-modal-panel.is-visible {
				transform: translateY(0);
			}
		}

		/* Modal Header */
		.fix-modal-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 1.25rem 1.5rem;
			border-bottom: 1px solid rgb(0 0 0 / 0.06);
			background: linear-gradient(to bottom, #FEFCE8, #FFFBEB);
		}

		@media (max-width: 640px) {
			.fix-modal-header {
				padding: 1rem 1.25rem;
			}

			/* Mobile drag indicator */
			.fix-modal-header::before {
				content: '';
				position: absolute;
				top: 0.5rem;
				left: 50%;
				transform: translateX(-50%);
				width: 2.5rem;
				height: 0.25rem;
				background-color: rgb(0 0 0 / 0.15);
				border-radius: 9999px;
			}
		}

		/* Close button */
		.fix-modal-close {
			display: flex;
			align-items: center;
			justify-content: center;
			width: 2.5rem;
			height: 2.5rem;
			border-radius: 0.75rem;
			background-color: rgb(0 0 0 / 0.05);
			color: #525252;
			cursor: pointer;
			transition: all 0.15s ease;
		}

		.fix-modal-close:hover {
			background-color: rgb(0 0 0 / 0.1);
			color: #171717;
		}

		/* Modal Content */
		.fix-modal-content {
			flex: 1;
			overflow-y: auto;
			padding: 1.5rem;
			display: flex;
			flex-direction: column;
			gap: 1.5rem;
		}

		@media (max-width: 640px) {
			.fix-modal-content {
				padding: 1.25rem;
			}
		}

		/* Phrase card */
		.fix-modal-phrase-card {
			padding: 1.25rem;
			border-radius: 1rem;
			background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
			border: 1px solid #FCD34D;
		}

		/* Section styling */
		.fix-modal-section {
			padding-bottom: 1.25rem;
			border-bottom: 1px solid rgb(0 0 0 / 0.06);
		}

		.fix-modal-section:last-child {
			border-bottom: none;
			padding-bottom: 0;
		}

		/* Prompt list item */
		.fix-modal-prompt {
			display: flex;
			align-items: flex-start;
			gap: 0.75rem;
			padding: 0.75rem;
			border-radius: 0.75rem;
			background-color: #F9FAFB;
			font-size: 0.875rem;
			color: #374151;
			line-height: 1.5;
		}

		.fix-modal-prompt-icon {
			flex-shrink: 0;
			width: 1.25rem;
			height: 1.25rem;
			color: #9CA3AF;
		}

		/* Modal Footer */
		.fix-modal-footer {
			padding: 1rem 1.5rem;
			border-top: 1px solid rgb(0 0 0 / 0.06);
			background-color: #FAFAFA;
		}

		@media (max-width: 640px) {
			.fix-modal-footer {
				padding: 1rem 1.25rem;
				padding-bottom: max(1rem, env(safe-area-inset-bottom));
			}
		}

		/* Done button */
		.fix-modal-done-btn {
			display: flex;
			align-items: center;
			justify-content: center;
			width: 100%;
			height: 3rem;
			border-radius: 0.75rem;
			font-size: 0.9375rem;
			font-weight: 600;
			color: white;
			background: linear-gradient(135deg, #059669 0%, #047857 100%);
			box-shadow: 0 2px 8px rgb(5 150 105 / 0.25);
			cursor: pointer;
			transition: all 0.15s ease;
		}

		.fix-modal-done-btn:hover {
			transform: translateY(-1px);
			box-shadow: 0 4px 12px rgb(5 150 105 / 0.3);
		}

		.fix-modal-done-btn:active {
			transform: translateY(0);
		}

		/* Prevent body scroll when modal is open */
		body.fix-modal-open {
			overflow: hidden;
		}
	</style>

	<script>
		import type { AnalysisMode, VowAnalysis, VowMatchSpan, TopPhraseEntry } from '../lib/vowReview/types'
		import { findWeakSpans } from '../lib/vowReview/matcher'
		import { analyzeText, emptyAnalysis, getSeverityBucketDisplay, getCategoryDisplayName } from '../lib/vowReview/scorer'
		import { renderHighlightedText } from '../lib/vowReview/render'

		// Window globals for cross-component communication
		// Using 'any' to avoid TS conflicts with multiple declarations
		const win = window as any

		// DOM elements
		const input = document.getElementById('text-input') as HTMLTextAreaElement | null
		const preview = document.getElementById('highlight-preview') as HTMLElement | null
		const resetBtn = document.getElementById('reset-btn') as HTMLButtonElement | null
		const modeSelect = document.getElementById('mode-select') as HTMLSelectElement | null
		const tooltip = document.getElementById('tooltip') as HTMLElement | null
		const tooltipTitle = document.getElementById('tooltip-title') as HTMLElement | null
		const tooltipWhy = document.getElementById('tooltip-why') as HTMLElement | null

		// Stat elements
		const totalWordsEl = document.querySelector('[data-stat="total-words"]') as HTMLElement | null
		const readTimeEl = document.querySelector('[data-stat="read-time"]') as HTMLElement | null
		const weakHitsEl = document.querySelector('[data-stat="weak-hits"]') as HTMLElement | null
		const uniquePhrasesEl = document.querySelector('[data-stat="unique-phrases"]') as HTMLElement | null
		const severityLabelEl = document.querySelector('[data-stat="severity-label"]') as HTMLElement | null
		const severityDescEl = document.querySelector('[data-stat="severity-description"]') as HTMLElement | null
		const lengthGuidanceEl = document.querySelector('[data-stat="length-guidance"]') as HTMLElement | null

		// Content elements
		const categoryBreakdown = document.getElementById('category-breakdown') as HTMLElement | null
		const topPhrasesEl = document.getElementById('top-phrases') as HTMLElement | null
		const insightsHeadlineEl = document.querySelector('[data-stat="insights-headline"]') as HTMLElement | null
		const insightsBulletsEl = document.getElementById('insights-bullets') as HTMLElement | null
		const insightsActionsEl = document.getElementById('insights-actions') as HTMLElement | null

		// Fix panel elements (modal)
		const fixPanel = document.getElementById('fix-panel') as HTMLElement | null
		const fixBackdrop = document.getElementById('fix-modal-backdrop') as HTMLElement | null
		const closePanelBtn = document.getElementById('close-fix-panel') as HTMLButtonElement | null
		const donePanelBtn = document.getElementById('fix-panel-done') as HTMLButtonElement | null
		const fixPhraseText = document.getElementById('fix-phrase-text') as HTMLElement | null
		const fixWhy = document.getElementById('fix-why') as HTMLElement | null
		const fixSuggestions = document.getElementById('fix-suggestions') as HTMLElement | null
		const fixPrompts = document.getElementById('fix-prompts') as HTMLElement | null

		// Initialize global state
		win.__vowReviewAnalysis = emptyAnalysis()
		win.__vowReviewMode = 'vows'

		/**
		 * Get current analysis mode.
		 */
		function getMode(): AnalysisMode {
			return (modeSelect?.value as AnalysisMode) || 'vows'
		}

		/**
		 * Update stats display.
		 */
		function updateStats(analysis: VowAnalysis): void {
			if (totalWordsEl) {
				totalWordsEl.textContent = analysis.totalWords.toLocaleString()
			}
			if (readTimeEl) {
				readTimeEl.textContent = analysis.readTimeLabel
			}
			if (weakHitsEl) {
				weakHitsEl.textContent = analysis.weakHits.toLocaleString()
			}
			if (uniquePhrasesEl) {
				uniquePhrasesEl.textContent = analysis.uniqueWeakPhrases.toLocaleString()
			}
			if (lengthGuidanceEl) {
				lengthGuidanceEl.textContent = analysis.lengthGuidance
			}

			// Update severity rating
			const severityDisplay = getSeverityBucketDisplay(analysis.severityBucket)
			if (severityLabelEl) {
				severityLabelEl.textContent = severityDisplay.label
				severityLabelEl.className = `text-3xl font-bold severity-${analysis.severityBucket}`
			}
			if (severityDescEl) {
				severityDescEl.textContent = severityDisplay.description
			}
		}

		/**
		 * Update category breakdown.
		 */
		function updateCategoryBreakdown(analysis: VowAnalysis): void {
			if (!categoryBreakdown) return

			const categories = Object.entries(analysis.categoryCounts)
				.filter(([, count]) => count > 0)
				.sort(([, a], [, b]) => b - a)

			if (categories.length === 0) {
				categoryBreakdown.innerHTML = '<p class="text-sm text-base-500">No issues detected yet.</p>'
				return
			}

			categoryBreakdown.innerHTML = categories
				.map(([category, count]) => `
					<div class="category-badge w-full">
						<span>${getCategoryDisplayName(category)}</span>
						<span class="font-semibold">${count}</span>
					</div>
				`)
				.join('')
		}

		/**
		 * Update top phrases list.
		 */
		function updateTopPhrases(topPhrases: TopPhraseEntry[]): void {
			if (!topPhrasesEl) return

			if (topPhrases.length === 0) {
				topPhrasesEl.innerHTML = '<p class="text-sm text-base-500">No issues detected yet.</p>'
				return
			}

			topPhrasesEl.innerHTML = topPhrases
				.map((phrase, index) => `
					<div class="flex items-start gap-2">
						<span class="text-base-400 font-mono text-sm">${index + 1}.</span>
						<div class="flex-1">
							<p class="font-medium text-base-800">"${escapeHtml(phrase.displayText)}"${phrase.count > 1 ? ` <span class="text-base-500">(${phrase.count}×)</span>` : ''}</p>
							<p class="text-xs text-base-500 mt-0.5">
								Try: ${phrase.suggestions.slice(0, 3).join(', ')}
							</p>
						</div>
					</div>
				`)
				.join('')
		}

		/**
		 * Update insights section.
		 */
		function updateInsights(analysis: VowAnalysis): void {
			if (insightsHeadlineEl) {
				insightsHeadlineEl.textContent = analysis.insights.headline
			}

			if (insightsBulletsEl) {
				insightsBulletsEl.innerHTML = analysis.insights.bullets
					.map(bullet => `<p class="text-base-600">• ${escapeHtml(bullet)}</p>`)
					.join('')
			}

			if (insightsActionsEl) {
				if (analysis.insights.actionSteps.length > 0) {
					insightsActionsEl.innerHTML = `
						<p class="font-medium text-base-700 mt-2">Action steps:</p>
						${analysis.insights.actionSteps.map((step, i) => `<p>${i + 1}. ${escapeHtml(step)}</p>`).join('')}
					`
				} else {
					insightsActionsEl.innerHTML = ''
				}
			}
		}

		/**
		 * Show fix panel modal for a phrase.
		 */
		function showFixPanel(span: VowMatchSpan): void {
			if (!fixPanel || !fixBackdrop) {
				console.error('Fix panel elements not found')
				return
			}
			if (!fixPhraseText || !fixWhy || !fixSuggestions || !fixPrompts) {
				console.error('Fix panel child elements not found')
				return
			}

			// Populate content
			fixPhraseText.textContent = `"${span.text}"`
			fixWhy.textContent = span.why

			const suggestionsArr = Array.isArray(span.suggestions) ? span.suggestions : []
			const promptsArr = Array.isArray(span.proofPrompts) ? span.proofPrompts : []

			fixSuggestions.innerHTML = suggestionsArr
				.slice(0, 8)
				.map(s => `<span class="suggestion-chip">${escapeHtml(s)}</span>`)
				.join('')

			fixPrompts.innerHTML = promptsArr
				.slice(0, 5)
				.map(p => `
					<li class="fix-modal-prompt">
						<svg class="fix-modal-prompt-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<circle cx="12" cy="12" r="10"></circle>
							<path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
							<path d="M12 17h.01"></path>
						</svg>
						<span>${escapeHtml(p)}</span>
					</li>
				`)
				.join('')

			// Show modal with animation
			fixBackdrop.classList.add('is-visible')
			fixPanel.classList.add('is-visible')
			document.body.classList.add('fix-modal-open')
			
			// Focus trap - focus the close button
			closePanelBtn?.focus()
		}

		/**
		 * Hide fix panel modal.
		 */
		function hideFixPanel(): void {
			if (fixPanel) {
				fixPanel.classList.remove('is-visible')
			}
			if (fixBackdrop) {
				fixBackdrop.classList.remove('is-visible')
			}
			document.body.classList.remove('fix-modal-open')
		}

		/**
		 * Show tooltip near an element.
		 */
		function showTooltip(element: HTMLElement, span: VowMatchSpan): void {
			if (!tooltip || !tooltipTitle || !tooltipWhy) return

			tooltipTitle.textContent = span.text
			tooltipWhy.textContent = span.why

			// Position tooltip near element
			const rect = element.getBoundingClientRect()
			const tooltipRect = tooltip.getBoundingClientRect()

			let left = rect.left
			let top = rect.bottom + 8

			// Keep tooltip in viewport
			if (left + 300 > window.innerWidth) {
				left = window.innerWidth - 310
			}
			if (top + tooltipRect.height > window.innerHeight) {
				top = rect.top - tooltipRect.height - 8
			}

			tooltip.style.left = `${left}px`
			tooltip.style.top = `${top}px`
			tooltip.classList.remove('hidden')
		}

		/**
		 * Hide tooltip.
		 */
		function hideTooltip(): void {
			if (tooltip) {
				tooltip.classList.add('hidden')
			}
		}

		/**
		 * Escape HTML to prevent XSS.
		 */
		function escapeHtml(str: string): string {
			const div = document.createElement('div')
			div.textContent = str
			return div.innerHTML
		}

		/**
		 * Render the highlighted preview.
		 */
		function renderPreview(text: string, mode: AnalysisMode): VowAnalysis {
			if (!preview) return emptyAnalysis()

			// Handle empty input
			if (!text.trim()) {
				preview.textContent = 'Your highlighted preview will appear here.'
				return emptyAnalysis()
			}

			try {
				// Find weak spans
				const spans = findWeakSpans(text, mode)

				// Render highlighted text
				const fragment = renderHighlightedText(text, spans)
				preview.replaceChildren(fragment)

				// Add event listeners to weak phrases
				const weakPhrases = preview.querySelectorAll('.weak-phrase')
				weakPhrases.forEach((el) => {
					const htmlEl = el as HTMLElement

					// Hover events
					htmlEl.addEventListener('mouseenter', () => {
						const spanData: VowMatchSpan = {
							start: parseInt(htmlEl.dataset.start || '0'),
							end: parseInt(htmlEl.dataset.end || '0'),
							text: htmlEl.textContent || '',
							phraseKey: htmlEl.dataset.phraseKey || '',
							category: htmlEl.dataset.category as VowMatchSpan['category'],
							severityWeight: parseInt(htmlEl.dataset.weight || '1') as VowMatchSpan['severityWeight'],
							why: htmlEl.dataset.why || '',
							suggestions: JSON.parse(htmlEl.dataset.suggestions || '[]'),
							proofPrompts: JSON.parse(htmlEl.dataset.proofPrompts || '[]'),
						}
						showTooltip(htmlEl, spanData)
					})

					htmlEl.addEventListener('mouseleave', () => {
						hideTooltip()
					})

					// Click event
					htmlEl.addEventListener('click', (e) => {
						e.stopPropagation() // Prevent document click handler from interfering
						
						try {
							const spanData: VowMatchSpan = {
								start: parseInt(htmlEl.dataset.start || '0'),
								end: parseInt(htmlEl.dataset.end || '0'),
								text: htmlEl.textContent || '',
								phraseKey: htmlEl.dataset.phraseKey || '',
								category: htmlEl.dataset.category as VowMatchSpan['category'],
								severityWeight: parseInt(htmlEl.dataset.weight || '1') as VowMatchSpan['severityWeight'],
								why: htmlEl.dataset.why || '',
								suggestions: JSON.parse(htmlEl.dataset.suggestions || '[]'),
								proofPrompts: JSON.parse(htmlEl.dataset.proofPrompts || '[]'),
							}
							hideTooltip()
							showFixPanel(spanData)
						} catch (err) {
							console.error('Error showing fix panel:', err)
						}
					})

					// Keyboard accessibility
					htmlEl.addEventListener('keydown', (e: KeyboardEvent) => {
						if (e.key === 'Enter' || e.key === ' ') {
							e.preventDefault()
							htmlEl.click()
						}
					})
				})

				// Compute analysis
				return analyzeText(text, spans, mode)
			} catch {
				// Fallback: show plain text on error
				preview.textContent = text
				return emptyAnalysis()
			}
		}

		/**
		 * Main update function.
		 */
		function update(): void {
			if (!input) return

			const text = input.value
			const mode = getMode()

			// Render preview and get analysis
			const analysis = renderPreview(text, mode)

			// Store globally
			win.__vowReviewAnalysis = analysis
			win.__vowReviewMode = mode

			// Update UI
			updateStats(analysis)
			updateCategoryBreakdown(analysis)
			updateTopPhrases(analysis.topPhrases)
			updateInsights(analysis)

			// Show/hide reset button
			if (resetBtn) {
				resetBtn.classList.toggle('hidden', !text.trim())
			}
		}

		/**
		 * Reset handler.
		 */
		function reset(): void {
			if (!input) return
			input.value = ''
			update()
			input.focus()
		}

		// Debounce with requestAnimationFrame
		let frameId = 0
		function scheduleUpdate(): void {
			if (frameId) return
			frameId = requestAnimationFrame(() => {
				frameId = 0
				update()
			})
		}

		// Event listeners
		if (input) {
			input.addEventListener('input', scheduleUpdate)
		}

		if (modeSelect) {
			modeSelect.addEventListener('change', update)
		}

		if (resetBtn) {
			resetBtn.addEventListener('click', reset)
		}

		// Modal close handlers
		if (closePanelBtn) {
			closePanelBtn.addEventListener('click', hideFixPanel)
		}

		if (donePanelBtn) {
			donePanelBtn.addEventListener('click', hideFixPanel)
		}

		// Close modal when clicking backdrop
		if (fixBackdrop) {
			fixBackdrop.addEventListener('click', hideFixPanel)
		}

		// Close modal with Escape key
		document.addEventListener('keydown', (e) => {
			if (e.key === 'Escape' && fixPanel?.classList.contains('is-visible')) {
				hideFixPanel()
			}
		})

		// Hide tooltip when clicking outside (but not when modal is open)
		document.addEventListener('click', (e) => {
			if (tooltip && !tooltip.contains(e.target as Node)) {
				hideTooltip()
			}
		})

		// Initialize on load
		update()
	</script>
</BaseLayout>
