---
/**
 * VowsNextStepCard.astro
 * A "Next step" recommendation card for vows.you that appears in tool sidebars.
 * Shows only when user has input, with dynamic copy based on analysis results.
 */

interface Props {
	show?: boolean
	variant?: 'default' | 'strong' | 'soft'
	toolName?: string
}

const { show = true, variant = 'default', toolName = '' } = Astro.props

// Don't render if show is explicitly false
if (!show) {
	return null
}
---

<div
	id="vows-next-step"
	class="hidden relative p-5 rounded-2xl border border-base-200 bg-white shadow-md mb-6 opacity-0 translate-y-[-8px] transition-all duration-250 ease-out"
	data-variant={variant}
	data-tool={toolName}
	role="complementary"
	aria-label="vows.you recommendation"
>
	<!-- Dismiss button -->
	<button
		type="button"
		class="absolute top-3 right-3 flex items-center justify-center w-6 h-6 rounded-md bg-transparent text-base-400 hover:bg-base-100 hover:text-base-600 transition-colors cursor-pointer"
		aria-label="Dismiss recommendation"
		id="vows-dismiss-btn"
	>
		<svg
			xmlns="http://www.w3.org/2000/svg"
			width="14"
			height="14"
			viewBox="0 0 24 24"
			fill="none"
			stroke="currentColor"
			stroke-width="2"
			stroke-linecap="round"
			stroke-linejoin="round"
			aria-hidden="true"
		>
			<path d="M18 6 6 18"></path>
			<path d="m6 6 12 12"></path>
		</svg>
	</button>

	<!-- Header row: Icon badge + Eyebrow label -->
	<div class="flex items-center gap-2 mb-2">
		<div class="flex items-center justify-center w-7 h-7 rounded-md bg-gradient-to-br from-accent-500 to-accent-600 text-white flex-shrink-0" aria-hidden="true">
			<svg
				xmlns="http://www.w3.org/2000/svg"
				width="16"
				height="16"
				viewBox="0 0 24 24"
				fill="none"
				stroke="currentColor"
				stroke-width="2.5"
				stroke-linecap="round"
				stroke-linejoin="round"
			>
				<path d="M12 20h9"></path>
				<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
			</svg>
		</div>
		<p class="text-xs font-semibold uppercase tracking-wide text-base-500">
			Next step
		</p>
	</div>

	<!-- Content wrapper -->
	<div class="flex flex-col">
		<!-- Default variant -->
		<div class="vows-card-variant" data-variant-content="default">
			<h4 class="text-lg font-bold text-base-900 mb-2 max-w-[22ch]">
				Write vows that sound like you
			</h4>
			<p class="text-sm text-base-600 mb-4">
				vows.you gives you prompts and structure to write personal, meaningful vows. No blank page panic.
			</p>
		</div>

		<!-- Strong variant -->
		<div class="vows-card-variant hidden" data-variant-content="strong">
			<h4 class="text-lg font-bold text-base-900 mb-2 max-w-[22ch]">
				Want help making these personal?
			</h4>
			<p class="text-sm text-base-600 mb-4">
				vows.you walks you through prompts to replace clichés with memories and promises that are uniquely yours.
			</p>
		</div>

		<!-- Soft variant -->
		<div class="vows-card-variant hidden" data-variant-content="soft">
			<h4 class="text-lg font-bold text-base-900 mb-2 max-w-[22ch]">
				Your vows are solid. Want to polish?
			</h4>
			<p class="text-sm text-base-600 mb-4">
				vows.you can help tighten phrasing and add moments that make guests tear up.
			</p>
		</div>

		<!-- CTA button -->
		<a
			href="https://vows.you"
			target="_blank"
			class="flex items-center justify-center w-full h-11 px-4 rounded-xl text-sm font-semibold text-white bg-gradient-to-br from-accent-500 to-accent-600 shadow-sm hover:opacity-90 active:scale-[0.98] transition-all mb-2"
		>
			Start writing with vows.you →
		</a>

		<!-- Microcopy / Trust line -->
		<p class="text-xs text-base-400 text-center">
			Guided prompts. Your voice, just clearer.
		</p>
	</div>
</div>

<script>
	// VowsNextStepCard client-side behavior
	const card = document.getElementById('vows-next-step') as HTMLElement | null
	const dismissBtn = document.getElementById('vows-dismiss-btn') as HTMLButtonElement | null
	const input = document.getElementById('text-input') as HTMLTextAreaElement | null

	let isDismissed = false

	function showCard(): void {
		if (!card || isDismissed) return
		card.classList.remove('hidden')
		// Trigger reflow for animation
		void card.offsetHeight
		card.classList.add('opacity-100', 'translate-y-0')
		card.classList.remove('opacity-0', 'translate-y-[-8px]')
	}

	function hideCard(): void {
		if (!card) return
		card.classList.remove('opacity-100', 'translate-y-0')
		card.classList.add('opacity-0', 'translate-y-[-8px]')
		setTimeout(() => {
			if (!card.classList.contains('opacity-100')) {
				card.classList.add('hidden')
			}
		}, 250)
	}

	function updateVariant(severityBucket: string): void {
		if (!card) return
		const variants = card.querySelectorAll('.vows-card-variant')
		
		let targetVariant = 'default'
		if (severityBucket === 'weak') {
			targetVariant = 'strong'
		} else if (severityBucket === 'great') {
			targetVariant = 'soft'
		}

		variants.forEach((el) => {
			const htmlEl = el as HTMLElement
			if (htmlEl.dataset.variantContent === targetVariant) {
				htmlEl.classList.remove('hidden')
			} else {
				htmlEl.classList.add('hidden')
			}
		})
	}

	function checkVisibility(): void {
		if (isDismissed || !input) return
		
		const hasInput = input.value.trim().length > 0
		const win = window as any
		const analysis = win.__vowReviewAnalysis
		const hasResults = analysis && analysis.totalWords > 0

		if (hasInput && hasResults) {
			updateVariant(analysis.severityBucket || 'fair')
			showCard()
		} else {
			hideCard()
		}
	}

	// Dismiss handler
	if (dismissBtn) {
		dismissBtn.addEventListener('click', () => {
			isDismissed = true
			hideCard()
		})
	}

	// Listen for input changes
	if (input) {
		input.addEventListener('input', () => {
			setTimeout(checkVisibility, 100)
		})
	}

	// Watch for analysis updates via MutationObserver on stats
	const statsEl = document.querySelector('[data-stat="total-words"]')
	if (statsEl) {
		const observer = new MutationObserver(() => {
			setTimeout(checkVisibility, 50)
		})
		observer.observe(statsEl, { childList: true, characterData: true, subtree: true })
	}

	// Initial check
	setTimeout(checkVisibility, 200)
</script>
